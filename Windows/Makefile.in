# Check for a .configured file generated by configure script
ifeq ($(wildcard .configured),)
$(error You must run `./configure` before you can build.)
endif

# Variables
APP_NAME = Notepad==
BUILD_DIR = dist
INSTALL_DIR = /opt/matthewyang
BIN_LINK = /usr/local/bin/notepadee
DESKTOP_FILE = /usr/share/applications/notepadee.desktop
VERSION_NUMBER = 5.2.2

.SILENT:

all: build

configure:
	./configure

build:
	pyinstaller --hidden-import=tkinter --windowed -i Notepad.ico src/$(APP_NAME).py
	cp Notepad.ico dist/Notepad==/
	touch dist/Notepad==/.pyinstaller
	$(MAKE) windows-app-icon
	echo "Build completed. To install, run 'sudo make install'"

windows-app-icon:
	cp Notepad.ico dist\Notepad==\_internal\

install:
	sudo mkdir -p $(INSTALL_DIR)
	sudo cp -R $(BUILD_DIR)/$(APP_NAME) $(INSTALL_DIR)/
	sudo ln -s $(INSTALL_DIR)/$(APP_NAME)/$(APP_NAME) $(BIN_LINK)
	sudo cp notepadee.desktop $(DESKTOP_FILE)
	sudo update-desktop-database
	echo "Install completed"

uninstall:
	sudo rm -rf /opt/matthewyang/$(APP_NAME)
	sudo rm -f $(BIN_LINK)
	sudo rm -rf $(DESKTOP_FILE)
	echo "Uninstalled. If issues experienced caused you to uninstall Notepad==, please report them on https://www.github.com/matthewyang204/NotepadEE."

clean: clean-dist clean-bin-dist
	rm -rf dist
	rm -rf build
	rm -rf $(APP_NAME).spec
	echo "Cleaned all temp files used"

dist: clean
	mkdir ../temp
	cp -R ./* ../temp/
	tar -czvf NotepadEE-Windows-src.tar.gz -C ../temp .
	rm -rf ../temp

clean-dist:
	rm -rf NotepadEE-Windows-src.tar.gz
	rm -rf ../temp

bin-dist:
	mkdir ../temp
	cp -R dist build *.spec notepadee.desktop ../temp/
	cp resources/dist.mak ../temp/Makefile
	tar -czvf NotepadEE-Windows-$(VERSION_NUMBER)-$(shell uname -m).tar.gz -C ../temp .
	rm -rf ../temp

clean-bin-dist: 
	rm -rf ../temp
	rm -rf NotepadEE-Windows-*.tar.gz

upgrade: uninstall-upgrade install

.PHONY: all configure build install uninstall clean dist bin-dist upgrade

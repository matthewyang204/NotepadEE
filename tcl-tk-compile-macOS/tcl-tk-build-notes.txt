# env vars
export SDKROOT="/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk"
export MACOSX_DEPLOYMENT_TARGET=10.13
export CFLAGS="-isysroot $SDKROOT -mmacosx-version-min=10.13"
export CPPFLAGS="$CFLAGS"
export LDFLAGS="-isysroot $SDKROOT -mmacosx-version-min=10.13"
export CFLAGS="-DHAVE_ICONV=1 $CFLAGS"

export ac_cv_func_iconv_works=no
export LIBS="-liconv"
export LDFLAGS="-liconv $LDFLAGS"

# You can use this gist to get older SDKs like the MacOSX10.15.sdk running on modern macOS
https://gist.github.com/kenji21/25a65a7161793bdc4b7b2641ac67b22a
- You can download Xcode 11.7 from Apple and extract the SDK
- Download the Xcode 11.5 Command Line Tools from Apple, extract, and copy 10.15's CLTools SDK package's payload contents manually
	- To do this, open all the way down to SDKs, and then copy the MacOSX{something}.sdk to clipboard
	- Then navigate down /Library/Developer all the way to the SDKs, and then paste

# Configure & build tcl first before anything else
./configure --prefix=/opt/tcl-tk --includedir=/opt/tcl-tk --enable-threads --enable-64bit
make -j$(sysctl -n hw.ncpu)
sudo make install
sudo make install-private-headers

# Configure & build tk
export CPPFLAGS="$CPPFLAGS -I/opt/tcl-tk" # This is required to add the freshly built tcl to header search path

# Need to comment out following lines in configure:
if test -d "/System/Library/Frameworks/UniformTypeIdentifiers.framework"; then
    LIBS="$LIBS -weak_framework UniformTypeIdentifiers"
fi

# Now build:
./configure --prefix=/opt/tcl-tk --includedir=/opt/tcl-tk --enable-threads --enable-64bit --enable-aqua=yes --without-x --with-tcl=/opt/tcl-tk/lib
make -j$(sysctl -n hw.ncpu)
sudo make install
sudo make install-private-headers

# Install critcl
sudo /opt/tcl-tk/bin/tclsh8.6 build.tcl install

# Configure, build, and install tcllib
./configure --prefix=/opt/tcl-tk
sudo make install -j$(sysctl -n hw.ncpu)
sudo make critcl -j$(sysctl -n hw.ncpu)
sudo cp -R modules/tcllibc /opt/tcl-tk/lib/
sudo ln -s /opt/tcl-tk/lib/tcllibc/macosx-x86_64-clang /opt/tcl-tk/lib/tcllibc/macosx-x86_64

# Configure, build, and install tcltls
./configure --with-ssl=openssl --with-openssl-dir=$(brew --prefix openssl@3) --prefix=/opt/tcl-tk
make -j$(sysctl -n hw.ncpu)
sudo make install